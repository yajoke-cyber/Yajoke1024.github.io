
<!DOCTYPE html>
<html lang="zh-CN">


<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#202020"/>
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>
  
  
    <meta name="keywords" content="thinking," />
  

  
    <meta name="description" content="哈哈哈哈哈" />
  
  
  <link rel="icon" type="image/x-icon" href="/logo.png">
  <title>Nginx [ Yajoke的小站 ]</title>
  
    <!-- stylesheets list from config.yml -->
    
      <link rel="stylesheet" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css">
    
      <link rel="stylesheet" href="/css/xoxo.css">
    
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <div class="nav-container">
    <nav class="home-menu pure-menu pure-menu-horizontal">
  <a class="pure-menu-heading" href="/">
    <img class="avatar" src="https://s4.ax1x.com/2021/12/20/Tu8HPA.jpg" />
    <span class="title">Yajoke的小站</span>
  </a>

  <ul class="pure-menu-list clearfix">
     
    <li class="pure-menu-item">
      <a href="/" class="pure-menu-link">首页</a>
    </li>
      
    <li class="pure-menu-item">
      <a href="/archives" class="pure-menu-link">归档</a>
    </li>
      
    <li class="pure-menu-item">
      <a href="/tags" class="pure-menu-link">标签</a>
    </li>
      
    <li class="pure-menu-item">
      <a href="/search" class="pure-menu-link">搜索</a>
    </li>
     
  </ul>
</nav>

  </div>

  <div class="container" id="content-outer">
    <div class="inner" id="content-inner">
      <div class="post-container">
  <article class="post" id="post">
    <header class="post-header text-center">
      <h1 class="title">Nginx</h1>
      <span>
        
        <time class="time" datetime="2021-12-20T09:40:44.000Z">
          2021-12-20
        </time>
        
      </span>
      <span class="slash">/</span>
      <span class="post-meta">
        <span class="post-tags">
          <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/thinking/" rel="tag">thinking</a></li></ul>
        </span>
      </span>
      <span class="slash">/</span>
      <span class="read"> <span id="busuanzi_value_page_pv"></span> 点击 </span>
      <span class="slash">/</span>
    </header>

    <div class="post-content"><h1 id="Nginx-与前端开发"><a href="#Nginx-与前端开发" class="headerlink" title="Nginx 与前端开发"></a>Nginx 与前端开发</h1><h3 id="Nginx-与-Node-js"><a href="#Nginx-与-Node-js" class="headerlink" title="Nginx 与 Node.js"></a>Nginx 与 Node.js</h3><blockquote>
<p>“Nginx 是一款轻量级的 HTTP 服务器，采用事件驱动的异步非阻塞处理方式框架，这让其具有极好的 IO 性能，时常用于服务端的反向代理和负载均衡。”</p>
</blockquote>
<p>作为前端开发，即使没用过 Nginx，但一定听说过上面这句话。这句经典的话，基本构成了所有人对 Nginx 的第一印象。</p>
<p>Nginx 发布于 2004 年，经过初期几年的沉淀之后，迅速蹿升为“网红”，成为了当年互联网技术圈最火的词汇和技术。然而经过多年的发展，到现在，当年的网红早已“过气”。因为如今基本上所有的大型网站都搭建在 Nginx 之上，Nginx 不再是一个什么新词，而是互联网网站搭建的必选技术之一。看到这里，“HTTP 服务器”、“事件驱动”、“异步非阻塞”以及 Nginx 的网红经历，是不是让前端童鞋们想到了 Nodejs?</p>
<p>在工作上，由于工作平台和语言的原因，对于大部分前端童鞋，更倾向于用 Nodejs 来搭建服务器，进而实现一些需求，对 Nginx 有天然的抗拒感。的确，Nginx 中的绝大部分功能，如果单纯的使用 Node.js 也可以满足和实现。但实际上，Nginx 和 Nodejs 并不冲突，都有自己擅长的领域：Nginx 更擅长于底层服务器端资源的处理（静态资源处理转发、反向代理，负载均衡等），Nodejs 更擅长于上层具体业务逻辑的处理。两者可以实现完美组合，助力前端开发。</p>
<p>其实通过 Nginx 可以强有力地助力前端开发，完全可以把之前 Node.js 的一些工作放到 Nginx 上，而不是痛苦地在 npm 中找包或者造轮子。但实际上，Nginx 种看似简单的配置，实则学问深深。在 Nginx 实现一个同样的功能，不同的配置编写写法，效率上可能差上好几倍。而这些完全是在建立在对 Nginx 原理的深入理解和常年的配置运维经验上，哪怕是资深的后端都可能对 Nginx 的了解并不深入。如果真的想深入学习 Nginx，还是找专业的 SA 或者 PE 请教吧。</p>
<h2 id="如何安装-Nginx"><a href="#如何安装-Nginx" class="headerlink" title="如何安装 Nginx"></a>如何安装 Nginx</h2><h3 id="CentOS-系统安装"><a href="#CentOS-系统安装" class="headerlink" title="CentOS 系统安装"></a>CentOS 系统安装</h3><p>一般来说是可以<strong>sudo yum install nginx</strong>来进行安装</p>
<p>如果软件仓库没有的话可以采用下面的方式进行安装</p>
<p>​ 1.yum install yum-utils</p>
<p>​ 2.到 cd /etc/yum.repos.d/ 目录下</p>
<p>​ 3.新建 vim nginx.repo 文件（vim 为 linux 自带的命令行文件编辑器，用来编辑修改文件）</p>
<p>​ 输入以下信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[nginx-stable]</span><br><span class="line">name=nginx stable repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/$releasever/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line"></span><br><span class="line">[nginx-mainline]</span><br><span class="line">name=nginx mainline repo</span><br><span class="line">baseurl=http://nginx.org/packages/mainline/centos/$releasever/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br></pre></td></tr></table></figure>

<p><img src="https://img2018.cnblogs.com/blog/1404518/201904/1404518-20190426121110487-244298043.png" alt="img"></p>
<p>​ 4.通过 yum search nginx 看看是否已经添加源成功。如果成功则执行下列命令安装 nginx。</p>
<p>​ yum install nginx</p>
<p>​ 安装完后，rpm -qa | grep nginx 查看</p>
<p>​ 启动 nginx：systemctl start nginx</p>
<p>​ 加入开机启动：systemctl enable nginx</p>
<p>​ 查看 nginx 的状态：systemctl status nginx</p>
<ol start="5">
<li>通过 yum search nginx 看看是否已经添加源成功。如果成功则执行下列命令安装 nginx。</li>
</ol>
<p>​ yum install nginx</p>
<p>​ 安装完后，rpm -qa | grep nginx 查看</p>
<p>​ 启动 nginx：systemctl start nginx</p>
<p>​ 加入开机启动：systemctl enable nginx</p>
<p>​ 查看 nginx 的状态：systemctl status nginx</p>
<p>​ 如果大家觉得我上面讲的对自己不适用或者不够详细可以去官网查看具体安装流程</p>
<p>​ <a target="_blank" rel="noopener" href="http://nginx.org/en/linux_packages.html#RHEL-CentOS">官网各种教程安装</a></p>
<h3 id="WSL-Ubutun-系统-安装"><a href="#WSL-Ubutun-系统-安装" class="headerlink" title="WSL(Ubutun 系统)安装"></a>WSL(Ubutun 系统)安装</h3><p>Ubutun 系统安装 nginx 就可以说是非常的简单了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo su root//切换到root最高权限用户</span><br><span class="line">apt-get install nginx</span><br></pre></td></tr></table></figure>

<p>两行代码即可成功安装</p>
<h2 id="Nginx-配置和命令行"><a href="#Nginx-配置和命令行" class="headerlink" title="Nginx 配置和命令行"></a>Nginx 配置和命令行</h2><p>nginx -s reopen #重启 Nginx</p>
<p>nginx -s reload #重新加载 Nginx 配置文件，然后以优雅的方式重启 Nginx</p>
<p>nginx -s stop #强制停止 Nginx 服务</p>
<p>nginx -s quit #优雅地停止 Nginx 服务（即处理完所有请求后再停止服务）</p>
<p>nginx -t #检测配置文件是否有语法错误，然后退出</p>
<p>nginx -?,-h #打开帮助信息</p>
<p>nginx -v #显示版本信息并退出</p>
<p>nginx -V #显示版本和配置选项信息，然后退出</p>
<p>nginx -t #检测配置文件是否有语法错误，然后退出</p>
<p>nginx -T #检测配置文件是否有语法错误，转储并退出</p>
<p>nginx -q #在检测配置文件期间屏蔽非错误信息</p>
<p>nginx -p prefix #设置前缀路径(默认是:/usr/share/nginx/)</p>
<p>nginx -c filename #设置配置文件(默认是:/etc/nginx/nginx.conf)</p>
<p>nginx -g directives #设置配置文件外的全局指令</p>
<p>killall nginx #杀死所有 nginx 进程</p>
<h2 id="Nginx-基本概念"><a href="#Nginx-基本概念" class="headerlink" title="Nginx 基本概念"></a>Nginx 基本概念</h2><p>Nginx 在启动时，会默认开放 80 端口，作为相应</p>
<h2 id="nginx-conf-文件的结构"><a href="#nginx-conf-文件的结构" class="headerlink" title="nginx.conf 文件的结构"></a>nginx.conf 文件的结构</h2><ul>
<li>Global: nginx 运行相关</li>
<li>events: 与用户的网络连接相关</li>
<li>http<ul>
<li>http Global: 代理，缓存，日志，以及第三方模块的配置</li>
<li>server<ul>
<li>server Global: 虚拟主机相关</li>
<li>location: 地址定向，数据缓存，应答控制，以及第三方模块的配置</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>所有的所有的所有的指令，都要以<code>;</code>结尾</p>
</blockquote>
<h2 id="nginx-运行相关的-Global-部分"><a href="#nginx-运行相关的-Global-部分" class="headerlink" title="nginx 运行相关的 Global 部分"></a>nginx 运行相关的 Global 部分</h2><h3 id="配置允许生成的-worker-process-数"><a href="#配置允许生成的-worker-process-数" class="headerlink" title="配置允许生成的 worker process 数"></a>配置允许生成的 worker process 数</h3><p>worker_processes auto; worker_processes 4;</p>
<blockquote>
<p>这个数字，跟电脑 CPU 核数要保持一致</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># grep ^proces /proc/cpuinfo</span><br><span class="line">processor       : 0</span><br><span class="line">processor       : 1</span><br><span class="line">processor       : 2</span><br><span class="line">processor       : 3</span><br><span class="line"># grep ^proces /proc/cpuinfo | wc -l</span><br><span class="line">4</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<h3 id="配置-nginx-进程-PID-存放路径"><a href="#配置-nginx-进程-PID-存放路径" class="headerlink" title="配置 nginx 进程 PID 存放路径"></a>配置 nginx 进程 PID 存放路径</h3><p>pid logs/nginx.pid;</p>
<blockquote>
<p>这里面保存的就是一个数字，nginx master 进程的进程号</p>
</blockquote>
<h3 id="配置错误日志的存放路径"><a href="#配置错误日志的存放路径" class="headerlink" title="配置错误日志的存放路径"></a>配置错误日志的存放路径</h3><p>error_log logs/error.log; error_log logs/error.log error;</p>
<h3 id="配置文件的引入"><a href="#配置文件的引入" class="headerlink" title="配置文件的引入"></a>配置文件的引入</h3><p>include mime.types; include fastcgi_params; include ../../conf/*.conf;</p>
<h2 id="Nginx-特色"><a href="#Nginx-特色" class="headerlink" title="Nginx 特色"></a>Nginx 特色</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /uri &#123;</span><br><span class="line">	stub_status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="stub-status"><a href="#stub-status" class="headerlink" title="stub_status"></a>stub_status</h3><p>用来看服务器当前的运行状态</p>
<p><img src="C:\Users\ASUS\AppData\Roaming\Typora\typora-user-images\image-20211211123804145.png" alt="image-20211211123804145"></p>
<p>下面为各个属性的作用</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/o7J13R"><img src="https://s4.ax1x.com/2021/12/11/o7J13R.png" alt="o7J13R.png"></a></p>
<h3 id="autoindex"><a href="#autoindex" class="headerlink" title="autoindex"></a>autoindex</h3><p>用来内网分享文件</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/o7JtHO"><img src="https://s4.ax1x.com/2021/12/11/o7JtHO.png" alt="o7JtHO.png"></a></p>
<p>语法: autoindex on | off; 默认值为 off</p>
<p>上下文： http 、server、location</p>
<h3 id="limit-conn"><a href="#limit-conn" class="headerlink" title="limit_conn"></a>limit_conn</h3><ul>
<li>用于限制客户端并发连接数</li>
<li>使用共享内存，对所有 worker 子进程生效</li>
</ul>
<p>相当于把标识为 key 连接数放置到一个特有的池子里面，并且还是一个限速池子</p>
<p>可以专门对某一 key 的客户端的 ip 进行限速</p>
<p><strong>上下文：</strong></p>
<p>http,server,location</p>
<p><strong>常用指令:</strong></p>
<p><strong>limit_conn_zone</strong></p>
<p>​ limit_conn_zone key zone= name:size;</p>
<p>​ 示例: limit_conn_zone $remote_addr zone=addr:10m;</p>
<p>1m 可以承受 3w2k 多个并发连接</p>
<p><strong>limit_conn_status</strong></p>
<p>后面接 code 状态码</p>
<p><strong>limit_conn_log_level</strong></p>
<p>info|notice|warn|error;</p>
<p>默认: error;</p>
<p>记录的日志信息的等级</p>
<p><strong>limit_conn</strong></p>
<p>limit_conn zone number;</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/o7Jd4H"><img src="https://s4.ax1x.com/2021/12/11/o7Jd4H.png" alt="o7Jd4H.png"></a></p>
<p>第一行是限制状态码</p>
<p>第二行是限制 error 日志等级</p>
<p>第三行是一次限制并发连接数</p>
<p>第四行是限制连接速率</p>
<h3 id="rewrite"><a href="#rewrite" class="headerlink" title="rewrite"></a>rewrite</h3><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/o7J0Cd"><img src="https://s4.ax1x.com/2021/12/11/o7J0Cd.png" alt="o7J0Cd.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/o7Jrvt"><img src="https://s4.ax1x.com/2021/12/11/o7Jrvt.png" alt="o7Jrvt.png"></a></p>
<h2 id="跨域问题"><a href="#跨域问题" class="headerlink" title="跨域问题"></a>跨域问题</h2><p><strong>跨域是指</strong>：<strong>浏览器 A</strong>从<strong>服务器</strong>B 获取的静态资源，包括 Html、Css、Js，然后在 Js 中通过 Ajax 访问 C 服务器的静态资源或请求。即：浏览器 A 从 B 服务器拿的资源，资源中想访问服务器 C 的资源。</p>
<p><strong>同源策略是指</strong>：<strong>浏览器 A</strong>从<strong>服务器 B</strong>获取的静态资源，包括 Html、Css、Js，为了用户安全，浏览器加了限制，其中的 Js 通过 Ajax 只能访问 B 服务器的静态资源或请求。即：浏览器 A 从哪拿的资源，那资源中就只能访问哪。</p>
<h3 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h3><p>什么是反向代理？ 互联网应用基本都基于 CS 基本结构，即 client 端和 server 端。代理其实就是在 client 端和真正的 server 端之前增加一层提供特定服务的服务器，即代理服务器。</p>
<ol>
<li><p>正向代理</p>
<p>反向代理不好理解，</p>
<p>正向代理</p>
<p>大家总有用过，翻墙工具其实就是一个正向代理工具。它会把 们访问墙外服务器 server 的网页请求，代理到一个可以访问该网站的代理服务器 proxy，这个代理服务器 proxy 把墙外服务器 server 上的网页内容获取，再转发给客户。具体的流程如下图。</p>
<p><img src="https://s4.ax1x.com/2021/12/08/oWAkPP.png" alt="oWAkPP.png">](<a target="_blank" rel="noopener" href="https://imgtu.com/i/oWAkPP">https://imgtu.com/i/oWAkPP</a>)</p>
<p>概括说：就是客户端和代理服务器可以直接互相访问，属于一个 LAN（局域网）；代理对用户是</p>
<p>非透明</p>
<p>的，即用户需要自己操作或者感知得到自己的请求被发送到代理服务器；代理服务器通过</p>
<p>代理用户端的请求来向域外服务器请求响应内容。</p>
</li>
<li><p>反向代理</p>
<p>则正好相反，先看流程图。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/oWAi5t"><img src="https://s4.ax1x.com/2021/12/08/oWAi5t.png" alt="oWAi5t.png"></a></p>
<p>在反向代理中（事实上，这种情况基本发生在所有的大型网站的页面请求中），客户端发送的请求，想要访问 server 服务器上的内容。但将被发送到一个代理服务器 proxy，这个代理服务器将把请求代理到和自己属于同一个 LAN 下的内部服务器上，而用户真正想获得的内容就储存在这些内部服务器上。看到区别了吗，这里 proxy 服务器代理的并不是客户，而是服务器，即向外部客户端提供了一个统一的代理入口，客户端的请求，都先经过这个 proxy 服务器，至于在内网真正访问哪台服务器内容，由这个 proxy 去控制。一般代理是指代理客户端，而这里代理的对象是服务器，这就是“反向”这个词的意思。Nginx 就是来充当这个 proxy 的作用。 概括说：就是代理服务器和真正 server 服务器可以直接互相访问，属于一个 LAN（服务器内网）；代理对用户是透明的，即无感知。不论加不加这个反向代理，用户都是通过相同的请求进行的，且不需要任何额外的操作；代理服务器通过代理内部服务器接受域外客户端的请求，并将请求发送到对应的内部服务器上。</p>
</li>
<li><p><strong>为什么要 Nginx 反向代理</strong> 使用反向代理最主要的两个原因： 1）安全及权限。可以看出，使用反向代理后，用户端将无法直接通过请求访问真正的内容服务器，而必须首先通过 Nginx。可以通过在 Nginx 层上将危险或者没有权限的请求内容过滤掉，从而保证了服务器的安全。 2）负载均衡。例如一个网站的内容被部署在若干台服务器上，可以把这些机子看成一个集群，那么 Nginx 可以将接收到的客户端请求“均匀地”分配到这个集群中所有的服务器上（内部模块提供了多种负载均衡算法），从而实现服务器压力的负载均衡。此外，nginx 还带有健康检查功能（服务器心跳检查），会定期轮询向集群里的所有服务器发送健康检查请求，来检查集群中是否有服务器处于异常状态，一旦发现某台服务器异常，那么在以后代理进来的客户端请求都不会被发送到该服务器上（直到后面的健康检查发现该服务器恢复正常），从而保证客户端访问的稳定性。</p>
</li>
</ol>
<h3 id="前端可以用-Nginx-做些什么"><a href="#前端可以用-Nginx-做些什么" class="headerlink" title="前端可以用 Nginx 做些什么"></a>前端可以用 Nginx 做些什么</h3><p>下面的内容建立在对 Nginx 配置有基本认知的情况下。如果没有的话，请先从网上查阅资料（例如<a href="https://link.juejin.cn/?target=http://www.nginx.cn/76.html">基本配置</a>）做简单了解。如果你想本地安装 Nginx，强烈建议采用<a href="https://link.juejin.cn/?target=http://www.nginx.cn/install">源码编译安装</a>，这样后续添加模块更为方便。</p>
<ol>
<li><p><strong>快速实现简单的访问限制</strong> 经常会遇到希望网站让某些特定用户的群体（比如只让公司内网）访问，或者控制某个 uri 不让人访问。Nginx 配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    location / &#123;</span><br><span class="line">        deny  192.168.1.100;</span><br><span class="line">        allow 192.168.1.10/200;</span><br><span class="line">        allow 10.110.50.16;</span><br><span class="line">        deny  all;</span><br><span class="line">    &#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>其实 deny 和 allow 是<strong>ngx_http_access_module</strong>模块（已内置）中的语法。采用的是从上到下匹配方式，匹配到就跳出不再继续匹配。上述配置的意思就是，首先禁止 192.168.1.100 访问，然后允许 192.168.1.10-200 ip 段内的访问（排除 192.168.1.100），同时允许 10.110.50.16 这个单独 ip 的访问，剩下未匹配到的全部禁止访问。实际生产中，经常和<strong>ngx_http_geo_module</strong>模块（可以更好地管理 ip 地址表，已内置）配合使用。</p>
</li>
<li><p><strong>解决跨域</strong> 在众多的解决跨域方式中， 都不可避免的都需要服务端进行支持， 使用 Nginx 可以纯前端解决请求跨域问题。 特别是在前后端分离调试时， 经常需要在本地起前端工程， 接口希望拉取服务端的实际数据而不是本地的 mock。 而如果本地程序直接访问远程接口， 肯定会遇到跨域问题。现在前端成熟的做法，一般是把 node proxy server 集成进来。事实上，用 Nginx 同样可以解决问题，甚至可以应用于线上。 本地起一个 nginx server。server_name 是 mysite-base.com，比如现在需要请求线上<a target="_blank" rel="noopener" href="http://www.kaola.com域下的线上接口/">www.kaola.com域下的线上接口</a> <a href="https://link.juejin.cn/?target=https://www.kaola.com/getPCBannerList.html">www.kaola.com/getPCBanner…</a> 的数据，当在页面里直接请求，浏览器会报错：</p>
<p><a href="https://link.juejin.cn/?target=www.romanysoft.com"><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/27/1661ac31c1944c05~tplv-t2oaga2asx-watermark.awebp" alt="img"></a></p>
<p>为了绕开浏览器的跨域安全限制，</p>
<p>现在需要将请求的域名改成 mysite-base.com</p>
<p>。同时约定一个 url 规则来表明代理请求的身份，然后 Nginx 通过匹配该规则，将请求代理回原来的域。Nginx 配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#请求跨域，这里约定代理请求url path是以/apis/开头</span><br><span class="line">location ^~/apis/ &#123;</span><br><span class="line">    # 这里重写了请求，将正则匹配中的第一个()中$1的path，拼接到真正的请求后面，并用break停止后续匹配</span><br><span class="line">    rewrite ^/apis/(.*)$ /$1 break;</span><br><span class="line">    proxy_pass https://www.kaola.com/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在页面代码里，把请求 url 换成<a target="_blank" rel="noopener" href="http://mysite-base.com/apis/getPCBannerList.html">http://mysite-base.com/apis/getPCBannerList.html</a> 。这样就可以正常请求到数据。 这样其实是通过 nginx，用类似于 hack 的方式规避掉了浏览器跨域限制，实现了跨域访问。</p>
</li>
<li><p><strong>适配 PC 与移动环境</strong> 现在很多网站都存在 PC 站和 H5 站两个站点，因此根据用户的浏览环境自动切换站点是很常见的需求。Nginx 可以通过内置变量$http_user_agent，获取到请求客户端的 userAgent，从而知道用户处于移动端还是 PC，进而控制重定向到 H5 站还是 PC 站。 以笔者本地为例，<a href="https://link.juejin.cn/?target=http://xn--pcmysite-base-qr11aj07i537axka.com">pc 端站点是 mysite-base.com</a>，<a href="https://link.juejin.cn/?target=http://xn--H5mysite-base-H5-yi57a459t.com">H5 端是 mysite-base-H5.com</a>。pc 端 Nginx 配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    location / &#123;</span><br><span class="line">        # 移动、pc设备适配</span><br><span class="line">        if ($http_user_agent ~* &#x27;(Android|webOS|iPhone|iPod|BlackBerry)&#x27;) &#123;</span><br><span class="line">            set $mobile_request &#x27;1&#x27;;</span><br><span class="line">        &#125;</span><br><span class="line">        if ($mobile_request = &#x27;1&#x27;) &#123;</span><br><span class="line">            rewrite ^.+ http://mysite-base-H5.com;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>这样当浏览设备切换成移动模式，再次刷新页面后，站点被自动切换到 H5 站。如下：</p>
<p><a href="https://link.juejin.cn/?target=www.romanysoft.com"><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/27/1661ac31c1a18887~tplv-t2oaga2asx-watermark.awebp" alt="img"></a></p>
</li>
<li><p><strong>合并请求</strong> 前端性能优化中重要一点就是尽量减少 http 资源请求的数量。通过<a href="https://link.juejin.cn/?target=https://github.com/alibaba/nginx-http-concat">nginx-http-concat</a>模块（淘宝开发的第三方模块，需要单独安装）用一种特殊的请求 url 规则（例子：<a href="https://link.juejin.cn/?target=http://example.com/">example.com/</a>??1.js,2.js,3.js ），前端可以将多个资源的请求合并成一个请求，后台 Nginx 会获取各个资源并拼接成一个结果进行返回。例如上面的例子通过一个请求将 1.js,2.js,3js 三个 js 资源合并成一个请求，减少了浏览器开销。 本地 server mysite-base.com 为例，static/js 文件夹下有三个文件，文件内容很简单，分别为：</p>
<p><a href="https://link.juejin.cn/?target=gif%E5%9B%BE"><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/27/1661ac31c0b189ea~tplv-t2oaga2asx-watermark.awebp" alt="img"></a></p>
<p>Nginx 配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    # js资源http-concat</span><br><span class="line">    # nginx-http-concat模块的参数远不止下面三个，剩下的请查阅文档</span><br><span class="line">    location /static/js/ &#123;</span><br><span class="line">        concat on; # 是否打开资源合并开关</span><br><span class="line">        concat_types application/javascript; # 允许合并的资源类型</span><br><span class="line">        concat_unique off; # 是否允许合并不同类型的资源</span><br><span class="line">        concat_max_files 5; # 允许合并的最大资源数目</span><br><span class="line">    &#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>当在浏览器请求<a target="_blank" rel="noopener" href="http://mysite-base.com/static/js/??a.js,b.js,c.js">http://mysite-base.com/static/js/??a.js,b.js,c.js</a> 时，发现三个 js 被合并成一个返回了，如下图：</p>
<p><a href="https://link.juejin.cn/?target=www.romanysoft.com"><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/27/1661ac31c27214fa~tplv-t2oaga2asx-watermark.awebp" alt="img"></a></p>
</li>
<li><p><strong>图片处理</strong> 在前端开发中，经常需要不同尺寸的图片。现在的云储存基本对图片都提供有处理服务（一般是通过在图片链接上加参数）。其实用 Nginx，可以通过几十行配置，搭建出一个属于自己的本地图片处理服务，完全能够满足日常对图片的裁剪/缩放/旋转/图片品质等处理需求。要用到<a href="https://link.juejin.cn/?target=http://nginx.org/en/docs/http/ngx_http_image_filter_module.html">ngx_http_image_filter_module</a>模块。这个模块是非基本模块，需要安装。 下面是图片缩放功能部分的 Nginx 配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 图片缩放处理</span><br><span class="line"># 这里约定的图片处理url格式：以 mysite-base.com/img/路径访问</span><br><span class="line">location ~* /img/(.+)$ &#123;</span><br><span class="line">    alias /Users/cc/Desktop/server/static/image/$1; #图片服务端储存地址</span><br><span class="line">    set $width -; #图片宽度默认值</span><br><span class="line">    set $height -; #图片高度默认值</span><br><span class="line">    if ($arg_width != &quot;&quot;) &#123;</span><br><span class="line">        set $width $arg_width;</span><br><span class="line">    &#125;</span><br><span class="line">    if ($arg_height != &quot;&quot;) &#123;</span><br><span class="line">        set $height $arg_height;</span><br><span class="line">    &#125;</span><br><span class="line">    image_filter resize $width $height; #设置图片宽高</span><br><span class="line">    image_filter_buffer 10M;   #设置Nginx读取图片的最大buffer。</span><br><span class="line">    image_filter_interlace on; #是否开启图片图像隔行扫描</span><br><span class="line">    error_page 415 = 415.png; #图片处理错误提示图，例如缩放参数不是数字</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://link.juejin.cn/?target=www.romanysoft.com"><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/27/1661ac31eb85e6f4~tplv-t2oaga2asx-watermark.awebp" alt="img"></a></p>
<p>这里只是最基本的配置。此外，可以通过 proxy_cache 配置 Nginx 缓存，避免每次请求都重新处理图片，减少 Nginx 服务器处理压力；还以可以通过和</p>
<p>nginx-upload-module</p>
<p>一起使用加入图片上传的功能等。</p>
</li>
<li><p><strong>页面内容修改</strong> Nginx 可以通过向页面底部或者顶部插入额外的 css 和 js 文件，从而实现修改页面内容。这个功能需要额外模块的支持，例如：<a href="https://link.juejin.cn/?target=https://github.com/alibaba/nginx-http-footer-filter">nginx_http_footer_filter</a>或者<a href="https://link.juejin.cn/?target=http://nginx.org/en/docs/http/ngx_http_addition_module.html">ngx_http_addition_module</a> (都需要安装)。 工作中，经常需要切换各种测试环境，而通过 switchhosts 等工具切换后，有时还需要清理浏览器 dns 缓存。可以通过页面内容修改+Nginx 反向代理来实现轻松快捷的环境切换。 这里首先在本地编写一段 js 代码（switchhost.js），里面的逻辑是：在页面插入 hosts 切换菜单以及点击具体某个环境时，将该 host 的 ip 和 hostname 储存在 cookie 中，最后刷新页面；接着编写一段 css 代码（switchhost.css）用来设置该 hosts 切换菜单的样式。 然后 Nginx 脚本配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        listen  443 ssl;</span><br><span class="line">        expires -1;</span><br><span class="line">        # 想要代理的域名</span><br><span class="line">        server_name m-element.kaola.com;</span><br><span class="line">        set $root /Users/cc/Desktop/server;</span><br><span class="line">        charset utf-8;</span><br><span class="line">        ssl_certificate      /usr/local/etc/nginx/m-element.kaola.com.crt;</span><br><span class="line">        ssl_certificate_key  /usr/local/etc/nginx/m-element.kaola.com.key;</span><br><span class="line"></span><br><span class="line">        # 设置默认$switch_host，一般默认为线上host，这里的1.1.1.1随便写的</span><br><span class="line">        set $switch_host &#x27;1.1.1.1&#x27;;</span><br><span class="line">        # 设置默认$switch_hostname，一般默认为线上&#x27;online&#x27;</span><br><span class="line">        set $switch_hostname &#x27;&#x27;;</span><br><span class="line">        # 从cookie中获取环境ip</span><br><span class="line">        if ($http_cookie ~* &quot;switch_host=(.+?)(?=;|$)&quot;) &#123;</span><br><span class="line">            set $switch_host $1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # 从cookie中获取环境名</span><br><span class="line">        if ($http_cookie ~* &quot;switch_hostname=(.+?)(?=;|$)&quot;) &#123;</span><br><span class="line">            set $switch_hostname $1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            expires -1;</span><br><span class="line">            index index.html;</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line">            #把html页面的gzip压缩去掉，不然sub_filter无法替换内容</span><br><span class="line">            proxy_set_header Accept-Encoding &#x27;&#x27;;</span><br><span class="line">            #反向代理到实际服务器ip</span><br><span class="line">            proxy_pass  http://$switch_host:80;</span><br><span class="line">            #全部替换</span><br><span class="line">            sub_filter_once off;</span><br><span class="line">            #ngx_http_addition_module模块替换内容。</span><br><span class="line">            # 这里在头部插入一段css，内容是hosts切换菜单的css样式</span><br><span class="line">            sub_filter &#x27;&lt;/head&gt;&#x27; &#x27;&lt;/head&gt;&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; media=&quot;screen&quot; href=&quot;/local/switchhost.css&quot; /&gt;&#x27;;</span><br><span class="line">            #将页面中的&#x27;网易考拉&#x27;文字后面加上环境名，便于开发识别目前环境</span><br><span class="line">            sub_filter &#x27;网易考拉&#x27; &#x27;网易考拉:$&#123;switch_hostname&#125;&#x27;;</span><br><span class="line">            #这里用了另一个模块nginx_http_footer_filter，其实上面的模块就行，只是为了展示用法</span><br><span class="line">            # 最后插入一段js，内容是hosts切换菜单的js逻辑</span><br><span class="line">            set $injected &#x27;&lt;script language=&quot;javascript&quot; src=&quot;/local/switchhost.js&quot;&gt;&lt;/script&gt;&#x27;;</span><br><span class="line">            footer &#x27;$&#123;injected&#125;&#x27;;</span><br><span class="line">        &#125;</span><br><span class="line">        # 对于/local/请求，优先匹配本地文件</span><br><span class="line">        # 所以上面的/local/switchhost.css，/local/switchhost.js会从本地获取</span><br><span class="line">        location ^~ /local/ &#123;</span><br><span class="line">            root $root;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p><a href="https://link.juejin.cn/?target=gif%E5%9B%BE"><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/9/27/1661ac31f0d611ca~tplv-t2oaga2asx-watermark.awebp" alt="img"></a></p>
<p>这个功能其实为 Nginx 在前端开发中的应用提供了无限可能。例如，可以通过区分本地、测试和线上环境，为本地/测试环境页面增加很多开发辅助功能：给本地页面加一个常驻二维码便于手机端扫码调试；本地调试线上页面时，在 js 文件底部塞入 sourceMappingURL，便于本地 debug 等等。</p>
</li>
</ol>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>上述只是通过一些简单的小例子，希望能够引起广大大佬对 Niginx 的兴趣。事实上，Nginx 不仅仅局限于这些微小的工作，在实际生产中作用其实更加巨大。对于有志于“大前端”的童靴，了解和熟悉 Nginx 绝对是必修技能之一。</p>
</div>

    <div>全文完。</div>
  </article>
  <div class="toc-container">
  <div id="toc" class="toc-article">
    <strong class="toc-title">目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx-%E4%B8%8E%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91"><span class="toc-text">Nginx 与前端开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-%E4%B8%8E-Node-js"><span class="toc-text">Nginx 与 Node.js</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%AE%89%E8%A3%85-Nginx"><span class="toc-text">如何安装 Nginx</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CentOS-%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85"><span class="toc-text">CentOS 系统安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WSL-Ubutun-%E7%B3%BB%E7%BB%9F-%E5%AE%89%E8%A3%85"><span class="toc-text">WSL(Ubutun 系统)安装</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-%E9%85%8D%E7%BD%AE%E5%92%8C%E5%91%BD%E4%BB%A4%E8%A1%8C"><span class="toc-text">Nginx 配置和命令行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-text">Nginx 基本概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx-conf-%E6%96%87%E4%BB%B6%E7%9A%84%E7%BB%93%E6%9E%84"><span class="toc-text">nginx.conf 文件的结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx-%E8%BF%90%E8%A1%8C%E7%9B%B8%E5%85%B3%E7%9A%84-Global-%E9%83%A8%E5%88%86"><span class="toc-text">nginx 运行相关的 Global 部分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%85%81%E8%AE%B8%E7%94%9F%E6%88%90%E7%9A%84-worker-process-%E6%95%B0"><span class="toc-text">配置允许生成的 worker process 数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-nginx-%E8%BF%9B%E7%A8%8B-PID-%E5%AD%98%E6%94%BE%E8%B7%AF%E5%BE%84"><span class="toc-text">配置 nginx 进程 PID 存放路径</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97%E7%9A%84%E5%AD%98%E6%94%BE%E8%B7%AF%E5%BE%84"><span class="toc-text">配置错误日志的存放路径</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%9A%84%E5%BC%95%E5%85%A5"><span class="toc-text">配置文件的引入</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-%E7%89%B9%E8%89%B2"><span class="toc-text">Nginx 特色</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#stub-status"><span class="toc-text">stub_status</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#autoindex"><span class="toc-text">autoindex</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#limit-conn"><span class="toc-text">limit_conn</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rewrite"><span class="toc-text">rewrite</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98"><span class="toc-text">跨域问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-text">反向代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E5%8F%AF%E4%BB%A5%E7%94%A8-Nginx-%E5%81%9A%E4%BA%9B%E4%BB%80%E4%B9%88"><span class="toc-text">前端可以用 Nginx 做些什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li></ol></li></ol></li></ol>
  </div>

</div>
</div>
<div class="copyright"></div>
 <div class="share" style="width: 100%">
  <!-- <img src="https://kevinofneu-blog-static.oss-cn-beijing.aliyuncs.com/static/2018-12-10-qrcode_for_gh_ffacf5722095_258.jpg" alt="Running Geek" style="margin: auto; display: block;"/>

  <div style="margin: auto; text-align: center; font-size: 0.8em; color: grey;">老铁们关注走一走，不迷路</div> -->
</div>
   
    <div class="post-nav">
      <div class="post-nav-item post-nav-next">
        
      </div>
  
      <div class="post-nav-item post-nav-prev">
          
          <a href="/2021/12/20/page2/" rel="prev" title="JavaScript基础">
            JavaScript基础
          </a>
          <span>〉</span>
        
      </div>
    </div>
   

    </div>

    

  </div>
  <footer class="footer text-center">
  <div id="bottom-inner">
    <a class="bottom-item" target="_blank" rel="noopener" href="https://Yajoke1024.github.io">首页</a>
    |
    <a
      class="bottom-item"
      href="https://space.bilibili.com/47626233"
      target="_blank"
      >B站</a
    >
    |
    <a class="bottom-item" href="https://github.com/Yajoke1024" target="_blank">GitHub</a> |
    <a
      class="bottom-item"
      href="https://juejin.cn/user/1346228642395912"
      target="_blank"
      >掘金</a
    >
  </div>
</footer>

  

<script>
  (function(window, document, undefined) {

    var timer = null;

    function returnTop() {
      cancelAnimationFrame(timer);
      timer = requestAnimationFrame(function fn() {
        var oTop = document.body.scrollTop || document.documentElement.scrollTop;
        if (oTop > 0) {
          document.body.scrollTop = document.documentElement.scrollTop = oTop - 50;
          timer = requestAnimationFrame(fn);
        } else {
          cancelAnimationFrame(timer);
        }
      });
    }

    var hearts = [];
    window.requestAnimationFrame = (function() {
      return window.requestAnimationFrame ||
        window.webkitRequestAnimationFrame ||
        window.mozRequestAnimationFrame ||
        window.oRequestAnimationFrame ||
        window.msRequestAnimationFrame ||
        function(callback) {
          setTimeout(callback, 1000 / 60);
        }
    })();
    init();

    function init() {
      css(".heart{z-index:9999;width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: absolute;}.heart:after{top: -5px;}.heart:before{left: -5px;}");
      attachEvent();
      gameloop();
      addMenuEvent();
    }

    function gameloop() {
      for (var i = 0; i < hearts.length; i++) {
        if (hearts[i].alpha <= 0) {
          document.body.removeChild(hearts[i].el);
          hearts.splice(i, 1);
          continue;
        }
        hearts[i].y--;
        hearts[i].scale += 0.004;
        hearts[i].alpha -= 0.013;
        hearts[i].el.style.cssText = "left:" + hearts[i].x + "px;top:" + hearts[i].y + "px;opacity:" + hearts[i].alpha + ";transform:scale(" + hearts[i].scale + "," + hearts[i].scale + ") rotate(45deg);background:" + hearts[i].color;
      }
      requestAnimationFrame(gameloop);
    }

    /**
     * 给logo设置点击事件
     * 
     * - 回到顶部
     * - 出现爱心
     */
    function attachEvent() {
      var old = typeof window.onclick === "function" && window.onclick;
      var logo = document.getElementById("logo");
      if (logo) {
        logo.onclick = function(event) {
          returnTop();
          old && old();
          createHeart(event);
        }
      }
      
    }

    function createHeart(event) {
      var d = document.createElement("div");
      d.className = "heart";
      hearts.push({
        el: d,
        x: event.clientX - 5,
        y: event.clientY - 5,
        scale: 1,
        alpha: 1,
        color: randomColor()
      });
      document.body.appendChild(d);
    }

    function css(css) {
      var style = document.createElement("style");
      style.type = "text/css";
      try {
        style.appendChild(document.createTextNode(css));
      } catch (ex) {
        style.styleSheet.cssText = css;
      }
      document.getElementsByTagName('head')[0].appendChild(style);
    }

    function randomColor() {
      // return "rgb(" + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + ")";
      return "#F44336";
    }

    function addMenuEvent() {
      var menu = document.getElementById('menu-main-post');
      if (menu) {
        var toc = document.getElementById('toc');
        if (toc) {
          menu.onclick = function() {
            if (toc) {
              if (toc.style.display == 'block') {
                toc.style.display = 'none';
              } else {
                toc.style.display = 'block';
              }
            }
          };
        } else {
          menu.style.display = 'none';
        }
      }
    }

  })(window, document);
</script>

  



</body>
</html>
